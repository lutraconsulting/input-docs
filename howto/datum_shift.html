<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Datum shift for projections | Input Help</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Datum shift for projections" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Survey made easy" />
<meta property="og:description" content="Survey made easy" />
<link rel="canonical" href="/howto/datum_shift" />
<meta property="og:url" content="/howto/datum_shift" />
<meta property="og:site_name" content="Input Help" />
<script type="application/ld+json">
{"description":"Survey made easy","url":"/howto/datum_shift","@type":"WebPage","headline":"Datum shift for projections","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="Input Help" /><!-- based on default minima template https://github.com/jekyll/minima/blob/master/_includes/google-analytics.html -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-144776738-1"></script>
<script>
  window['ga-disable-UA-144776738-1'] = window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1";
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  // we need more settings than in default template
  gtag('config', 'UA-144776738-1', {
    'linker': {
      'domains': ['inputapp.io', 'cloudmergin.com'],
      'accept_incoming': true
    },
    'anonymize_ip': true
  });
</script>
</head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">
    <img src="https://inputapp.io/img/logo.svg" style="margin-top: -10px" width="90">
    <!--Input Help-->
    </a> <span class="site-title"> &nbsp; Help Center</span><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/quick-start.html">Quick Start Guide</a><a class="page-link" href="/faq">FAQ</a><a class="page-link" href="/developers.html">Developers</a><a class="page-link" href="/support">Support</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">Datum shift for projections</h1>
  </header>

  <div class="post-content">
    <h1 id="map-projections">Map Projections</h1>

<p><strong>Map projection</strong> is the operation defining how to show/display spatial data (your data with associated coordinate reference system) on
2D flat surface (QGIS map canvas or printed paper map).
There are various types of projections that are used in cartography (planar projection, cylindrical projections, conic projections).
Each type of projection could preserve some attribute of the 2d “flat” map. Some projections preserve distance,
others areas, etc. For example Mercator Projection was created to display accurate compass bearings for sea travel.</p>

<p>You can read more about map projections in the <a href="https://docs.qgis.org/testing/en/docs/gentle_gis_introduction/coordinate_reference_systems.html#map-projection-in-detail">QGIS docs</a>
or <a href="https://en.wikipedia.org/wiki/Map_projection">Wikipedia</a>.</p>

<h1 id="coordinate-reference-systems">Coordinate Reference Systems</h1>

<p>All your spatial data include information about where your data is located on earth. Let’s say you to store the position
of a heritage tree. You may stand next to it with GPS receiver and note down latitude and longitude and altitude of the
place. Two numbers in degrees and one in meters. You think the three numbers will mark exactly the heritage
tree position for your children. Not that easy. What if in 50 years the GPS will be replaced by some different technology
not using the latitude and longitude? Or let’s say the tree is in Australia. The continent sits on the world’s
fastest-moving continental tectonic plate with speed around 7 centimeters per year. And your GPS position is related to the
global/world coordinates. Ok, at least we should mark down to our notes the date when we captured the coordinates and
which <strong>coordinate reference system</strong> (CRS) we used.</p>

<p>Sometimes the coordinates of spatial data are in meters or feet, sometimes in degrees and therefore you need also coordinate reference system which
defines how your spatial data could be transformed to the position on the Earth. Each coordinate reference system could be
geographic (e.g. for whole globe, using latitude and longitude in degrees) or projected
(for example the Great Britain or part of the USA, using metric units as feets). So the coordinate reference system consists of:</p>

<ul>
  <li>the mathematical <strong>parameters</strong> such as an origin and scale (e.g. prime meridian which specifies the location of 0° longitude)</li>
  <li>horizontal (and vertical) <strong>units</strong> (degrees, meters, feet, …)</li>
  <li><strong>datum</strong>, the ellipsoid/geoid which represents the Earth’s shape and its position relative to the surface</li>
</ul>

<p>The coordinate reference systems are not set in stone. Most of them are part of <a href="https://en.wikipedia.org/wiki/EPSG_Geodetic_Parameter_Dataset">EPSG registry</a>
and they have associated the simple number that can be looked up and the precise definition could be found out.
To elaborate on our example with the heritage tree in Australia, you could have used <a href="https://en.wikipedia.org/wiki/Geocentric_Datum_of_Australia_1994">GDA94</a>.</p>

<p>When we want to show the data stored in one coordinate reference system on a map in other coordinate reference system (e.g. when
we have multiple layers each with different coordinate system), we need to do <strong>transformation</strong>. When two
coordinate systems do not use the same datum, there are multiple ways how to transform from system one to another.
This operation is typically only approximate and multiple operations may exist for different purposes,
or depending on how the data was originally collected in the first place. Therefore as spatial data users we need to
make an informed choice about which operation is fit for purpose and the correct one to use for your current project.</p>

<p>More detailed information about the coordinate reference systems and projections could be found
in the <a href="https://docs.qgis.org/testing/en/docs/gentle_gis_introduction/coordinate_reference_systems.html">QGIS online documentation</a>
or <a href="https://proj.org/operations/index.html">PROJ documentation</a>.</p>

<h1 id="how-is-it-used-in-qgis">How is it used in QGIS?</h1>

<p>QGIS is FOSS (free and open source) software standing on the shoulders of other FOSS libraries. Notably projection support
is handled by <a href="https://proj.org">PROJ</a>. The version proj4 was used for decades, but in recent years it was recreated
from scratch to reflect the recent modern ways for handling transformations and the increasing demand for
high precision location. Different version of PROJ uses different set of resource files required to handle projections
accurately. See <a href="https://proj.org/resource_files.html">PROJ help</a> for details.
Most importantly, the recent release of QGIS 3.16 LTR and QGIS 3.18 for all platforms is on PROJ6+ version.</p>

<p>Your QGIS installation contains the basic set of PROJ resources required for most day-to-day work. But if you
need some special coordinate reference systems, the required files for <a href="https://github.com/OSGeo/PROJ-data">PROJ7</a> and for
<a href="https://github.com/OSGeo/proj-datumgrid">PROJ6</a> are available online. Also note that QGIS can automatically download the
required files for your when requested. Just follow the instructions when you see the QGIS warning in the transformation
dialog:</p>

<p><img src="../images/QGIS_Transformations2.png" alt="QGIS Transformations British National Grid to World Geodetic System" /></p>

<h1 id="example-capture-gps-point-for-great-britain">Example Capture GPS point for Great Britain</h1>

<p>For example, imagine we have a project for the Great Britain, where we use map projection British National Grid (EPSG:27700) to display map. We have background
map in the same coordinate reference system, so there is no datum transformation required to show it. However we want
to capture point by GPS receiver in the field by <a href="https://inputapp.io">Input app</a>, and we add a point layer in WGS 84
coordinate reference system. When we add point to this point layer, we store the coordinate values (latitude and longitude received from
GPS) as is in the data section of our layer. When we want to show the point on the QGIS map canvas, QGIS needs to first do
datum transformation, following by map projection.</p>

<p><img src="../images/projection_transformation.png" alt="projection transformation" /></p>

<h2 id="1-datum-transformation">1. Datum transformation</h2>

<p>British National Grid (EPSG:27700) is based on datum OSGB 1936 which is different from WGS 84.
QGIS recognizes that there is possibility to do datum transformation in multiple ways
so user is asked to select the one from the list:</p>

<p><img src="../images/transformations_qgis.png" alt="QGIS select transformation" /></p>

<p>In this case, the recommended transform is the
<a href="https://www.ordnancesurvey.co.uk/business-government/tools-support/os-net/for-developers">OSTN15 transformation</a>
which uses a grid file to transform coordinates.
Other transforms are using <a href="https://en.wikipedia.org/wiki/Helmert_transformation">Helmert transformation</a> method and offer
lower accuracy. Grid files for transforms are usually not shipped with QGIS.
But QGIS <em>offers to auto install</em> these to the correct location for you! These files are then automatically used for all your projects if required. Once this is selected and ready, QGIS calls
PROJ library to do datum transformation.</p>

<h2 id="2-map-projection">2. Map projection</h2>

<p>Once the data is in the same datum, they are projected to 2d flat space (map canvas) and rendered to the user in QGIS or <a href="https://inputapp.io">Input app</a>.</p>

<h1 id="what-could-possibly-go-wrong">What could possibly go wrong?</h1>

<p>There are multiple scenarios where you can end up with shifted or misplaced points on your map.</p>

<p>Probably most commonly the misplaced data are when the coordinate reference system of layers is not defined or
assigned incorrectly.</p>

<p>Other issues are visible when:</p>
<ol>
  <li>datum transformation needs to be done during reprojection (i.e. GPS / survey layer / map do not have the
same geodetic datum)</li>
  <li>AND the datum transformation is not correct.</li>
</ol>

<p>For example imagine that you digitised your point to be in the corner of the rectangle in QGIS desktop. But when opened
in the Input app in the field it is obviously shifted by dozens of centimetres. Or other way around, you digitise the
point in the field, and when opened in QGIS it is misplaced.</p>

<p><img src="../images/digitizing_shift.png" alt="shift of the point" /></p>

<p>The likely reason is that there is correctly downloaded and used extra datum shift file in QGIS, but missing in
Input app (more information in <a href="/blog/2021/04/22/projections-field/">this blog</a>)</p>

<h1 id="qgis-transformation-tab">QGIS Transformation tab</h1>

<p>QGIS exposes a nice interface for coordinate reference systems through the Transformation tab in Settings.
It is powered by <a href="https://proj.org/index.html">PROJ</a>, which tries to find the <a href="https://proj.org/operations/operations_computation.html">best available</a>
transformation route from the source to the destination coordinate reference system.</p>

<p>Let’s say we want to setup default transformation between British National Grid (EPSG:27700) and
World Geodetic System used in GPS (EPSG:4326) for all our future QGIS projects.</p>

<p><img src="../images/QGIS_Transformations_Dialog.png" alt="QGIS Transformation Dialog" /></p>

<p>Using the “+” button we add a new entry and select EPSG:27700 and EPSG:4326.
Let’s examine the first transformation with the accuracy of 1 meter:</p>

<p><img src="../images/QGIS_Transformations2.png" alt="QGIS Transformations British National Grid to World Geodetic System" /></p>

<p>At the bottom there is an interesting PROJ description line with pipeline to be used by underlying PROJ library.
You can read more about <a href="https://proj.org/operations/pipeline.html">PROJ pipeline</a>, but to start with
it definition of several mathematical operations to be done:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>+proj=pipeline
+step +inv +proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy
+step +proj=hgridshift +grids=OSTN15_NTv2_OSGBtoETRS.gsb
+step +proj=unitconvert +xy_in=rad +xy_out=deg
</code></pre></div></div>

<p>Huh. Let’s see if we can get at least some information from it by help of <a href="https://proj.org/">PROJ documentation</a>
We see there are 3 steps:</p>
<ul>
  <li>inversion <code class="language-plaintext highlighter-rouge">+inv</code> for the <code class="language-plaintext highlighter-rouge">tmerc</code>(<a href="https://proj.org/operations/projections/tmerc.html">Transverse Mercator</a>) with <a href="https://proj.org/operations/projections/airy.html?highlight=airy">Airy</a> ellipsoid (“map projection”)</li>
  <li>following by <code class="language-plaintext highlighter-rouge">hgridshift</code>(<a href="https://proj.org/operations/transformations/hgridshift.html?highlight=hgridshift">Horizontal grid shift</a>) defined by <strong>datum shift file</strong> <code class="language-plaintext highlighter-rouge">OSTN15_NTv2_OSGBtoETRS.gsb</code> (“datum transformation”)</li>
  <li>finally unit conversion from radians to degrees (GPS coordinates are in degrees)</li>
</ul>

<p>Well, quite importantly for second step you have to have <strong>datum shift file</strong> <code class="language-plaintext highlighter-rouge">OSTN15_NTv2_OSGBtoETRS.gsb</code> on your computer.
If you do not have it, this is why there is a big red warning in the dialog. But <strong>QGIS is always nice to you</strong> and offers you
to automatically download and store it for later use!</p>

<p>You can check the downloaded PROJ files in these locations:</p>

<ul>
  <li>For Windows users: <code class="language-plaintext highlighter-rouge">C:\Users\USER\AppData\Roaming\QGIS\QGIS3\profiles\default\proj</code> (replace USER with your username)</li>
  <li>For macOS users: <code class="language-plaintext highlighter-rouge">~/Library/Application\ Support/QGIS/QGIS3/profiles/default/proj</code></li>
  <li>For Linux users: <code class="language-plaintext highlighter-rouge">~/.local/share/QGIS/QGIS3/profiles/default/proj</code></li>
</ul>

  </div>

</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Input Help</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Input Help</li><li><a class="u-email" href="mailto:info@lutraconsulting.co.uk">info@lutraconsulting.co.uk</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://www.facebook.com/lutraconsulting"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#facebook"></use></svg> <span class="username">lutraconsulting</span></a></li><li><a href="https://github.com/lutraconsulting"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">lutraconsulting</span></a></li><li><a href="https://www.linkedin.com/in/lutra-consulting"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg> <span class="username">lutra-consulting</span></a></li><li><a href="https://www.twitter.com/lutraconsulting"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">lutraconsulting</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Survey made easy</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
